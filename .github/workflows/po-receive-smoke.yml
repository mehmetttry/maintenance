name: PO Receive Smoke
on:
  workflow_dispatch:
  push:

jobs:
  smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # SQLAlchemy'yi net olarak kur
          python -m pip install SQLAlchemy==2.0.43
          # Projenin asÄ±l gereksinimleri
          python -m pip install -r backend/requirements.txt

      - name: Seed demo data (best-effort)
        env:
          DATABASE_URL: sqlite:///./test.db
        run: |
          $ErrorActionPreference = 'Continue'
          if (Test-Path "backend/scripts/seed_demo.py") {
            Write-Host "Running seed script..."
            $code = "import os,runpy; os.chdir('backend'); os.environ['PYTHONPATH']=os.getcwd(); runpy.run_path('scripts/seed_demo.py', run_name='__main__')"
            python -c "$code"
            $exit = $LASTEXITCODE
            if ($exit -ne 0) {
              Write-Host "Seed failed (non-fatal). Continuing..."
              $global:LASTEXITCODE = 0
            }
          } else {
            Write-Host "Seed script not found. Skipping."
          }

      - name: Start API (Uvicorn) in background
        env:
          DATABASE_URL: sqlite:///./test.db
        run: |
          $ErrorActionPreference = 'Stop'
          $apiPort = 8011
          $apiHost = "127.0.0.1"
          Write-Host "Starting Uvicorn on http://$apiHost`:$apiPort"
          $job = Start-Job -ScriptBlock {
            Set-Location "backend"
            python -m uvicorn app.main:app --host 127.0.0.1 --port 8011
          }
          $health = "http://$apiHost`:$apiPort/health"
          $ok = $false
          foreach ($i in 1..60) {
            try {
              $r = Invoke-WebRequest -Uri $health -UseBasicParsing -TimeoutSec 3
              if ($r.StatusCode -eq 200) { $ok = $true; break }
            } catch { Start-Sleep -Seconds 1 }
          }
          if (-not $ok) {
            Receive-Job $job -Keep | Out-Host
            Stop-Job $job -Force | Out-Null
            throw "API health endpoint is not ready: $health"
          }
          Set-Content -Path "$env:RUNNER_TEMP\uvicorn_job_id.txt" -Value $job.Id -Encoding ascii

      - name: Run PO Receive smoketest
        run: |
          $ErrorActionPreference = 'Stop'
          .\backend\tests\po-receive-smoketest.ps1 -PartId 1 -Cleanup -CI

      - name: Stop API
        if: always()
        run: |
          if (Test-Path "$env:RUNNER_TEMP\uvicorn_job_id.txt") {
            $jid = Get-Content "$env:RUNNER_TEMP\uvicorn_job_id.txt" | Select-Object -First 1
            try { Stop-Job -Id $jid -Force -ErrorAction SilentlyContinue | Out-Null } catch {}
            Receive-Job -Id $jid -Keep -ErrorAction SilentlyContinue | Out-Host
          }
          Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force
